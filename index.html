<!DOCTYPE html>
<html>
<head>
    <title>London Explorer 3D</title>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: 'Segoe UI', sans-serif; background: #000; }
        #map { height: 100%; width: 100%; position: absolute; }
        
        /* Game HUD */
        #ui-panel { 
            position: absolute; top: 20px; left: 20px; z-index: 100; 
            background: rgba(10, 10, 10, 0.9); color: #00ff00; padding: 20px; 
            border: 2px solid #00ff00; border-radius: 12px; width: 260px;
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.3);
        }
        .stat { font-family: 'Courier New', monospace; font-size: 1.2em; margin: 10px 0; }
        #mission-box { background: rgba(255, 255, 255, 0.15); padding: 12px; border-radius: 8px; margin-top: 10px; }
        
        /* Mini-Map Overlay */
        #mini-map { 
            position: absolute; bottom: 30px; right: 30px; width: 180px; height: 180px; 
            border: 3px solid #00ff00; border-radius: 50%; z-index: 100; 
            overflow: hidden; box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        
        /* Game Over Screen */
        #game-over {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.95); z-index: 1000; flex-direction: column; 
            align-items: center; justify-content: center; color: #ff4444; text-align: center;
        }
        
        button { 
            padding: 15px 30px; font-size: 1.1em; background: #00ff00; border: none; 
            border-radius: 5px; cursor: pointer; font-weight: bold; margin-top: 20px;
        }
    </style>
</head>
<body>

    <div id="game-over">
        <h1 style="font-size: 4em; margin: 0;">MISSION FAILED</h1>
        <p style="color: white; font-size: 1.2em;">You ran out of fuel over the Thames!</p>
        <button onclick="location.reload()">REDEPLOY DRONE</button>
    </div>

    <div id="ui-panel">
        <h2 style="margin:0; color:white;">LONDON PILOT</h2>
        <div class="stat">FUEL: <span id="fuel-display">100</span>%</div>
        <div id="mission-box">
            <small style="color:#aaa;">OBJECTIVE:</small><br>
            <b id="target-name" style="color:#00ff00">Initializing...</b>
            <div id="target-dist" style="font-size:0.8em; color:white; margin-top:5px;">Dist: --m</div>
        </div>
        <div style="font-size:0.7em; margin-top:15px; color:#666;">
            WASD: Move | QE: Tilt | Space: Take Photo
        </div>
    </div>

    <div id="mini-map"></div>
    <div id="map"></div>

    <script async src="https://unpkg.com/es-module-shims@1.8.0/dist/es-module-shims.js"></script>
    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "@googlemaps/three": "https://unpkg.com/@googlemaps/three@1.0.2/dist/index.esm.js"
        }
    }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { ThreeJSOverlayView } from '@googlemaps/three';

        // --- AUTHENTICATION ---
        const CONFIG = {
            KEY: "YOUR_API_KEY_HERE",
            MAP_ID: "YOUR_MAP_ID_HERE",
            START_POS: { lat: 51.5033, lng: -0.1195, altitude: 70 }
        };

        const MISSIONS = [
            { name: "The London Eye", lat: 51.5033, lng: -0.1195 },
            { name: "Big Ben", lat: 51.5007, lng: -0.1246 },
            { name: "The Shard", lat: 51.5045, lng: -0.0865 },
            { name: "Tower Bridge", lat: 51.5055, lng: -0.0754 }
        ];

        let map, miniMap, overlay, playerMesh;
        let playerPos = { ...CONFIG.START_POS };
        let heading = 0;
        let tilt = 65;
        let fuel = 100;
        let missionIdx = 0;
        const keys = {};

        async function init() {
            const { Map } = await google.maps.importLibrary("maps");
            
            // Primary 3D Renderer
            map = new Map(document.getElementById("map"), {
                center: { lat: playerPos.lat, lng: playerPos.lng },
                zoom: 18, tilt: tilt, heading: heading,
                mapId: CONFIG.MAP_ID,
                disableDefaultUI: true, gestureHandling: "none"
            });

            // Mini-Map Renderer
            miniMap = new Map(document.getElementById("mini-map"), {
                center: { lat: playerPos.lat, lng: playerPos.lng },
                zoom: 14, mapId: CONFIG.MAP_ID,
                disableDefaultUI: true, gestureHandling: "none"
            });

            setupThreeJS();
        }

        function setupThreeJS() {
            const scene = new THREE.Scene();
            
            // Player Mesh (Drone Style)
            const geometry = new THREE.CylinderGeometry(0, 5, 12, 4);
            const material = new THREE.MeshPhongMaterial({ color: 0x00ff00, emissive: 0x003300 });
            playerMesh = new THREE.Mesh(geometry, material);
            playerMesh.rotation.x = Math.PI / 2;
            scene.add(playerMesh);

            scene.add(new THREE.AmbientLight(0xffffff, 0.7));
            const light = new THREE.DirectionalLight(0xffffff, 1);
            light.position.set(0, 100, 100);
            scene.add(light);

            overlay = new ThreeJSOverlayView({ map, scene, anchor: { ...playerPos }, THREE });

            window.addEventListener('keydown', e => keys[e.code] = true);
            window.addEventListener('keyup', e => keys[e.code] = false);

            requestAnimationFrame(gameLoop);
            
            // Collision Check Interval (Performance friendly)
            setInterval(checkCollision, 300);
        }

        async function checkCollision() {
            if (fuel <= 0) return;
            const elevation = await map.getAltitude({ lat: playerPos.lat, lng: playerPos.lng });
            if (elevation && elevation.altitude >= playerPos.altitude) {
                fuel -= 15; 
                document.getElementById('ui-panel').style.background = "rgba(255,0,0,0.5)";
                setTimeout(() => document.getElementById('ui-panel').style.background = "rgba(10,10,10,0.9)", 200);
            }
        }

        function gameLoop() {
            if (fuel <= 0) {
                document.getElementById('game-over').style.display = 'flex';
                return;
            }

            const moveStep = 0.00008;
            if (keys['KeyA']) heading -= 2.0;
            if (keys['KeyD']) heading += 2.0;
            if (keys['KeyW']) {
                playerPos.lat += Math.cos(heading * Math.PI / 180) * moveStep;
                playerPos.lng += Math.sin(heading * Math.PI / 180) * moveStep;
                fuel -= 0.02;
            }
            if (keys['KeyQ']) tilt = Math.min(tilt + 1, 85);
            if (keys['KeyE']) tilt = Math.max(tilt - 1, 30);

            // Sync Visuals
            overlay.setAnchor({ lat: playerPos.lat, lng: playerPos.lng, altitude: playerPos.altitude });
            playerMesh.rotation.z = -heading * Math.PI / 180;
            
            map.moveCamera({ center: { lat: playerPos.lat, lng: playerPos.lng }, heading: heading, tilt: tilt });
            miniMap.setCenter({ lat: playerPos.lat, lng: playerPos.lng });

            updateUI();
            requestAnimationFrame(gameLoop);
        }

        function updateUI() {
            const target = MISSIONS[missionIdx];
            const dist = getDistance(playerPos.lat, playerPos.lng, target.lat, target.lng) * 1000;
            
            document.getElementById('fuel-display').innerText = Math.floor(fuel);
            document.getElementById('target-name').innerText = target.name;
            document.getElementById('target-dist').innerText = `Dist: ${Math.floor(dist)}m`;

            if (dist < 40) {
                fuel = 100;
                missionIdx = (missionIdx + 1) % MISSIONS.length;
                alert("Target Reached! Next Location Locked.");
            }
        }

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        // Script Loader
        (function(g){var db=document,p="https://maps.googleapis.com/maps/api/js?key="+CONFIG.KEY+"&v=beta&libraries=maps,marker&callback=init&map_ids="+CONFIG.MAP_ID;var s=db.createElement("script");window.init=init;s.src=p;db.head.appendChild(s);})();
    </script>
</body>
</html>
