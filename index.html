<!DOCTYPE html>
<html>
<head>
    <title>London Navigator 3D</title>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: 'Segoe UI', sans-serif; background: #000; }
        #map { height: 100%; width: 100%; position: absolute; }
        #ui-panel { position: absolute; top: 20px; left: 20px; z-index: 100; background: rgba(10,10,10,0.9); color: #00ff00; padding: 20px; border: 2px solid #00ff00; border-radius: 12px; width: 260px; }
        .stat { font-family: 'Courier New', monospace; font-size: 1.2em; margin: 10px 0; }
        #mini-map { position: absolute; bottom: 30px; right: 30px; width: 180px; height: 180px; border: 3px solid #00ff00; border-radius: 50%; z-index: 100; overflow: hidden; }
        #game-over { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 1000; flex-direction: column; align-items: center; justify-content: center; color: #ff4444; }
        button { padding: 15px 30px; background: #00ff00; border: none; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>
    <div id="game-over"><h1>MISSION FAILED</h1><button onclick="location.reload()">RETRY</button></div>
    <div id="ui-panel">
        <h2 style="margin:0">LONDON PILOT</h2>
        <div class="stat">FUEL: <span id="fuel-display">100</span>%</div>
    </div>
    <div id="mini-map"></div>
    <div id="map"></div>

    <script async src="https://unpkg.com/es-module-shims@1.8.0/dist/es-module-shims.js"></script>
    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "@googlemaps/three": "https://unpkg.com/@googlemaps/three@1.0.2/dist/index.esm.js"
        }
    }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { ThreeJSOverlayView } from '@googlemaps/three';

        const CONFIG = {
            KEY: "YOUR_API_KEY_HERE",
            MAP_ID: "YOUR_MAP_ID_HERE",
            START_POS: { lat: 51.5033, lng: -0.1195, altitude: 70 }
        };

        let map, miniMap, overlay, playerMesh;
        let playerPos = { ...CONFIG.START_POS };
        let heading = 0;
        let fuel = 100;
        const keys = {};

        async function init() {
            if (google.maps.WebGLOverlayView && !google.maps.WebglOverlayView) {
                google.maps.WebglOverlayView = google.maps.WebGLOverlayView;
            }
            const { Map } = await google.maps.importLibrary("maps");
            map = new Map(document.getElementById("map"), {
                center: { lat: playerPos.lat, lng: playerPos.lng },
                zoom: 18, tilt: 65, heading: heading,
                mapId: CONFIG.MAP_ID, disableDefaultUI: true, gestureHandling: "none"
            });
            miniMap = new Map(document.getElementById("mini-map"), {
                center: { lat: playerPos.lat, lng: playerPos.lng },
                zoom: 14, mapId: CONFIG.MAP_ID, disableDefaultUI: true
            });
            setupThreeJS();
        }

        function setupThreeJS() {
            const scene = new THREE.Scene();
            const geometry = new THREE.ConeGeometry(5, 15, 4);
            const material = new THREE.MeshPhongMaterial({ color: 0x00ff00, emissive: 0x002200 });
            playerMesh = new THREE.Mesh(geometry, material);
            playerMesh.rotation.x = Math.PI / 2;
            scene.add(playerMesh);
            scene.add(new THREE.AmbientLight(0xffffff, 0.8));
            overlay = new ThreeJSOverlayView({ map, scene, anchor: { ...playerPos }, THREE });
            window.addEventListener('keydown', e => keys[e.code] = true);
            window.addEventListener('keyup', e => keys[e.code] = false);
            requestAnimationFrame(gameLoop);
        }

        function gameLoop() {
            if (fuel <= 0) { document.getElementById('game-over').style.display = 'flex'; return; }
            if (keys['KeyA']) heading -= 2.0;
            if (keys['KeyD']) heading += 2.0;
            if (keys['KeyW']) {
                playerPos.lat += Math.cos(heading * Math.PI / 180) * 0.00007;
                playerPos.lng += Math.sin(heading * Math.PI / 180) * 0.00007;
                fuel -= 0.02;
            }
            if (overlay) { overlay.anchor = { lat: playerPos.lat, lng: playerPos.lng, altitude: playerPos.altitude }; }
            if (playerMesh) { playerMesh.rotation.z = -heading * Math.PI / 180; }
            map.moveCamera({ center: { lat: playerPos.lat, lng: playerPos.lng }, heading: heading });
            miniMap.setCenter({ lat: playerPos.lat, lng: playerPos.lng });
            document.getElementById('fuel-display').innerText = Math.floor(fuel);
            requestAnimationFrame(gameLoop);
        }

        (function(g){
            var db=document, p="https://maps.googleapis.com/maps/api/js?key="+CONFIG.KEY+"&v=beta&libraries=maps,marker&callback=init&map_ids="+CONFIG.MAP_ID;
            var s=db.createElement("script"); window.init=init; s.src=p; db.head.appendChild(s);
        })(window);
    </script>
</body>
</html>
