<!DOCTYPE html>
<html>
<head>
    <title>London 3D: Pro Pilot</title>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: 'Segoe UI', sans-serif; background: #000; }
        #map { height: 100%; width: 100%; position: absolute; }
        #ui { 
            position: absolute; top: 20px; left: 20px; z-index: 100; 
            background: rgba(10, 10, 10, 0.9); color: #00ff00; padding: 20px; 
            border: 2px solid #00ff00; border-radius: 12px; width: 260px;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.2);
        }
        .stat { font-family: 'Courier New', monospace; font-size: 1.2em; margin: 10px 0; }
        .controls { font-size: 0.8em; color: #aaa; margin-top: 15px; border-top: 1px solid #333; pt: 10px; }
        #error-msg { color: #ff4444; font-size: 0.8em; display: none; }
    </style>
</head>
<body>

    <div id="ui">
        <h2 style="margin:0 0 10px 0;">LONDON MISSION</h2>
        <div id="error-msg">‚ö†Ô∏è Map ID or API Key Missing!</div>
        <div class="stat">FUEL: <span id="fuel-val">100</span>%</div>
        <div class="stat">SPD: <span id="speed-val">NORMAL</span></div>
        <div id="mission-text" style="color:white; font-size: 0.9em;">Target: Reach the <b>London Eye</b></div>
        
        <div class="controls">
            [W][S] Thrust | [A][D] Turn<br>
            [Q][E] Tilt View
        </div>
    </div>

    <div id="map"></div>

    <script async src="https://unpkg.com/es-module-shims@1.8.0/dist/es-module-shims.js"></script>
    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "@googlemaps/three": "https://unpkg.com/@googlemaps/three@1.0.2/dist/index.esm.js"
        }
    }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { ThreeJSOverlayView } from '@googlemaps/three';

        // --- GAME CONFIG ---
        const API_KEY = "YOUR_API_KEY"; // REPLACE THIS
        const MAP_ID = "YOUR_MAP_ID";   // REPLACE THIS (Must be 'Vector' type)
        
        let map, overlay, playerMesh;
        let playerPos = { lat: 51.5033, lng: -0.1195, altitude: 60 };
        let heading = 0;
        let tilt = 65;
        let fuel = 100;
        let currentSpeed = 0.00006;
        const keys = {};

        // --- INITIALIZE GAME ---
        async function initGame() {
            if (API_KEY === "YOUR_API_KEY") {
                document.getElementById('error-msg').style.display = 'block';
            }

            const { Map } = await google.maps.importLibrary("maps");
            
            map = new Map(document.getElementById("map"), {
                center: { lat: playerPos.lat, lng: playerPos.lng },
                zoom: 18,
                tilt: tilt,
                heading: heading,
                mapId: MAP_ID,
                disableDefaultUI: true,
                gestureHandling: "none" // Disable mouse drag to keep it "game-like"
            });

            setupThreeJS();
        }

        function setupThreeJS() {
            const scene = new THREE.Scene();
            
            // Player Avatar (Glowy Diamond)
            const geometry = new THREE.OctahedronGeometry(6, 0);
            const material = new THREE.MeshPhongMaterial({ 
                color: 0x00ff00, 
                emissive: 0x00ff00,
                emissiveIntensity: 0.5,
                flatShading: true 
            });
            playerMesh = new THREE.Mesh(geometry, material);
            scene.add(playerMesh);

            // Lighting
            const light = new THREE.DirectionalLight(0xffffff, 1);
            light.position.set(0, 100, 0);
            scene.add(light);
            scene.add(new THREE.AmbientLight(0xffffff, 0.7));

            overlay = new ThreeJSOverlayView({
                map,
                scene,
                anchor: { ...playerPos },
                THREE
            });

            window.addEventListener('keydown', e => keys[e.code] = true);
            window.addEventListener('keyup', e => keys[e.code] = false);

            requestAnimationFrame(gameLoop);
        }

        // --- MAIN GAME LOOP ---
        function gameLoop() {
            let moved = false;

            if (fuel > 0) {
                // Rotation
                if (keys['KeyA']) { heading -= 2.5; moved = true; }
                if (keys['KeyD']) { heading += 2.5; moved = true; }

                // Movement
                if (keys['KeyW']) {
                    playerPos.lat += Math.cos(heading * Math.PI / 180) * currentSpeed;
                    playerPos.lng += Math.sin(heading * Math.PI / 180) * currentSpeed;
                    fuel -= 0.03;
                    moved = true;
                }

                // Tilt View
                if (keys['KeyQ']) { tilt = Math.min(tilt + 1, 85); moved = true; }
                if (keys['KeyE']) { tilt = Math.max(tilt - 1, 30); moved = true; }
            }

            if (moved) {
                // Update ThreeJS Avatar
                overlay.setAnchor({ lat: playerPos.lat, lng: playerPos.lng, altitude: playerPos.altitude });
                playerMesh.rotation.y += 0.05; // Spin effect
                
                // Update Camera
                map.moveCamera({
                    center: { lat: playerPos.lat, lng: playerPos.lng },
                    heading: heading,
                    tilt: tilt
                });

                // Check distance to London Eye
                const distToEye = calculateDistance(playerPos.lat, playerPos.lng, 51.5033, -0.1195);
                if (distToEye < 0.05) {
                    document.getElementById('mission-text').innerHTML = "üèÅ <b style='color:gold'>GOAL REACHED!</b>";
                }
            }

            document.getElementById('fuel-val').innerText = Math.max(0, Math.floor(fuel));
            requestAnimationFrame(gameLoop);
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        // --- BOOTSTRAP ---
        (function(g){var db=document,qs="querySelector",cb="callback",p="https://maps.googleapis.com/maps/api/js?key="+API_KEY+"&v=beta&libraries=maps,marker&callback=initGame&map_ids="+MAP_ID;var s=db.createElement("script");window.initGame=initGame;s.src=p;db.head.appendChild(s);})();
    </script>
</body>
</html>